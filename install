OC_MAJOR_VER="v3"
OC_MINOR_VER=6
OC_MINI_VER=173
OCP_VERSION="$OC_MAJOR_VER.$OC_MINOR_VER"

#!/bin/bash
#disable and stop the firewall
systemctl disable firewalld
systemctl stop firewalld

mkdir $HOME/bin
PATH="$HOME/bin:$PATH"

if ($proxy_on); then
        echo "export http_proxy=http://$proxy:$proxyport" >> ~/.bashrc
        echo "export https_proxy=https://$proxy:$proxyport" >> ~/.bashrc
        echo "export no_proxy=127.0.0.1,localhost,*.sccloudinfra.net,10.0.0.0/8,$myip,*.nip.io" >> ~/.bashrc
    fi
    
source ~/.bashrc

subscription-manager clean
subscription-manager config --server.insecure=1
subscription-manager register --org=$rhsm_org --activationkey=$rhsm_activationkey
subscription-manager repos --disable="*"
subscription-manager repos --enable="rhel-7-server-rpms" --enable="rhel-7-server-extras-rpms"
cp /usr/share/rhn/RHNS-CA-CERT /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT

yum install docker -y
echo '{"insecure-registries": ["172.30.0.0/16"]}'> /etc/docker/daemon.json
if ($proxy_on); then
        mkdir -p /etc/systemd/system/docker.service.d
        touch /etc/systemd/system/docker.service.d/proxy.conf
        echo "[Service]" > /etc/systemd/system/docker.service.d/proxy.conf
        echo "Environment=HTTP_PROXY=http://$proxy:$proxyport" >> /etc/systemd/system/docker.service.d/proxy.conf
        echo "Environment=HTTPS_PROXY=https://$proxy:$proxyport" >> /etc/systemd/system/docker.service.d/proxy.conf
        echo "Environment=NO_PROXY=172.30.1.1" >> /etc/systemd/system/docker.service.d/proxy.conf
    fi
sudo systemctl daemon-reload
sudo systemctl restart docker

curl -sSL https://github.com/openshift/origin/releases/download/v3.7.0-rc.0/openshift-origin-client-tools-v3.7.0-rc.0-e92d5c5-linux-64bit.tar.gz -o oc.tar.gz
tar xvfz oc.tar.gz
cp openshift-origin-client-tools-v3.7.0-rc.0-e92d5c5-linux-64bit/oc $HOME/bin/

if ($proxy_on); then
        oc cluster up --public-hostname="$myip.nip.io" --routing-suffix="apps.$myip.nip.io" --http-proxy=http://$proxy:$proxyport --https-proxy=https://$proxy:$proxyport --no-proxy=*.nip.io --image=registry.access.redhat.com/openshift3/ose --host-data-dir=/var/lib/origin/ocp-data --host-config-dir=/var/lib/origin/openshift.local.config --use-existing-config=true --version=$OCP_VERSION --host-pv-dir=/var/lib/origin/openshift.local.pv
    else
        oc cluster up --public-hostname="$myip.nip.io" --routing-suffix="apps.$myip.nip.io" --image=registry.access.redhat.com/openshift3/ose --host-data-dir=/var/lib/origin/ocp-data --host-config-dir=/var/lib/origin/openshift.local.config --use-existing-config=true --version=$OCP_VERSION --host-pv-dir=/var/lib/origin/openshift.local.pv
    fi
